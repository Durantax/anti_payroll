# 통합 테스트 가이드

## 🎯 테스트 목표

Flutter 앱과 서버 간의 모든 기능이 정상 작동하는지 확인합니다.

## 📋 사전 준비

### 1. Hamachi VPN 연결 확인

```bash
# Windows에서:
ping 25.2.89.129
```

**예상 결과:**
```
Reply from 25.2.89.129: bytes=32 time=10ms TTL=64
```

### 2. DB 초기화 (최초 1회)

```bash
cd C:\work\payroll
python init_db.py
```

**예상 결과:**
```
✅ AppSettings 삽입 완료
✅ SmtpConfig 삽입 완료
✅ DB 초기화 완료!
```

### 3. 서버 실행

```bash
cd C:\work\payroll
python server.py
```

**예상 결과:**
```
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 4. 서버 상태 확인

새 터미널에서:

```bash
cd C:\work\payroll
python test_server.py
```

**예상 결과:** 모든 테스트 항목이 ✅로 표시됨

## 🧪 Flutter 앱 테스트

### 테스트 1: 앱 시작 및 설정 로드

**목표:** 앱이 서버에서 설정을 정상적으로 로드하는지 확인

**절차:**
1. Flutter 앱 실행: `flutter run -d windows`
2. 앱이 로딩 화면 없이 바로 메인 화면으로 전환되는지 확인

**예상 결과:**
- ✅ 로딩 완료
- ✅ 에러 메시지 없음
- ✅ 거래처 목록이 드롭다운에 표시됨

**실패 시:**
- `python test_server.py` 실행하여 서버 상태 확인
- `python init_db.py` 재실행
- 서버 재시작

---

### 테스트 2: 거래처 선택 및 직원 목록 로드

**목표:** 거래처 선택 시 직원 목록이 정상 로드되는지 확인

**절차:**
1. 드롭다운에서 거래처 선택 (예: 삼성전자)
2. 직원 목록 테이블이 나타나는지 확인
3. 사번(EmpNo) 컬럼 확인

**예상 결과:**
- ✅ 직원 목록 표시됨
- ✅ 사번(EmpNo) 필드에 4자리 숫자 표시 (예: 0001, 0002)
- ✅ 생년월일, 월급여, 시급 등 모든 필드 정상 표시

**확인 항목:**
| 항목 | 상태 |
|------|------|
| 직원 목록 로드 | ✅ / ❌ |
| 사번(EmpNo) 표시 | ✅ / ❌ |
| 생년월일 표시 | ✅ / ❌ |
| 급여 정보 표시 | ✅ / ❌ |

---

### 테스트 3: 신규 직원 추가 (사번 자동 생성)

**목표:** 신규 직원 추가 시 서버에서 사번이 자동 생성되는지 확인

**절차:**
1. "직원 추가" 버튼 클릭
2. 직원 정보 입력:
   - 이름: 테스트직원
   - 생년월일: 1990-01-01
   - 구분: 근로소득
   - 월급여: 3000000
3. "저장" 클릭
4. 직원 목록에서 새 직원의 사번 확인

**예상 결과:**
- ✅ 직원 저장 성공
- ✅ 사번 자동 생성됨 (예: 0005)
- ✅ 직원 목록에 즉시 반영
- ✅ 파일명에 사번 포함 (예: 테스트직원(0005)_2025년01월_급여명세서.pdf)

---

### 테스트 4: 월별 근무 데이터 입력 (두루누리)

**목표:** 월별 근무 데이터 입력 및 두루누리 체크박스 작동 확인

**절차:**
1. 직원 목록에서 직원 선택 후 "수정" 클릭
2. "월별 근무" 탭 선택
3. 근무 데이터 입력:
   - 근무일수: 22
   - 통상근무시간: 176
   - 야간시간: 10
   - 휴일시간: 8
4. **두루누리** 체크박스 체크
5. "저장" 클릭

**예상 결과:**
- ✅ 근무 데이터 저장 성공
- ✅ 두루누리 체크 상태 저장됨
- ✅ 다시 수정 화면 진입 시 두루누리 체크 유지

**DB 확인 (선택사항):**
```sql
SELECT EmployeeId, Ym, IsDurunuri 
FROM dbo.PayrollMonthlyData 
WHERE EmployeeId = [직원ID] AND Ym = '202501'
```

**예상 결과:** IsDurunuri = 1

---

### 테스트 5: 급여 계산 (두루누리 포함)

**목표:** 급여 계산 시 두루누리가 정확히 적용되는지 확인

**절차:**
1. 월별 근무 데이터가 입력된 직원의 "계산" 버튼 클릭
2. 급여 계산 결과 확인:
   - 지급총액
   - 공제총액 (두루누리 포함)
   - 실수령액

**예상 결과:**
- ✅ 급여 계산 완료
- ✅ 두루누리 지원금 적용됨
- ✅ 급여명세서에 두루누리 항목 표시

**두루누리 계산 검증:**
- 고용보험: 사용자 부담 * 50%
- 국민연금: 사용자 부담 * 50%

---

### 테스트 6: 급여 확정 (마감)

**목표:** 급여 계산 결과를 확정하고 마감 상태 확인

**절차:**
1. 직원 목록에서 체크박스 클릭 (마감)
2. 하단 "마감 현황" 바 확인
3. 설정 화면에서 "마감 현황" 탭 선택

**예상 결과:**
- ✅ 체크박스 상태 변경됨
- ✅ 마감 현황에 숫자 업데이트 (예: 3/5)
- ✅ 설정 화면에서 마감된 직원 목록 표시

---

### 테스트 7: 급여명세서 생성 (파일명 사번 포함)

**목표:** 급여명세서 파일 생성 시 사번이 파일명에 포함되는지 확인

**절차:**
1. 급여 계산 완료된 직원 선택
2. "급여명세서 보기" 클릭
3. "PDF 저장" 또는 "HTML 저장" 클릭
4. 저장된 파일명 확인

**예상 결과:**
- ✅ 파일 저장 성공
- ✅ 파일명에 사번 포함: `홍길동(0001)_2025년01월_급여명세서.pdf`
- ✅ OneDrive 또는 Documents 폴더에 저장
- ✅ 거래처별 하위 폴더 생성됨

**파일명 형식:**
```
[이름]([사번])_[YYYY년MM월]_급여명세서.[확장자]
```

예시:
- 홍길동(0001)_2025년01월_급여명세서.pdf
- 김철수(0002)_2025년01월_급여명세서.html

---

### 테스트 8: SMTP 설정 및 이메일 발송

**목표:** SMTP 설정 저장 및 이메일 발송 테스트

**절차:**
1. 설정 아이콘 클릭
2. "SMTP 설정" 탭 선택
3. SMTP 정보 입력:
   - Host: smtp.gmail.com
   - Port: 587
   - Username: your-email@gmail.com
   - Password: your-app-password
   - UseSSL: 체크
4. "저장" 클릭
5. 급여명세서 이메일 발송 테스트

**예상 결과:**
- ✅ SMTP 설정 저장 성공
- ✅ 이메일 발송 성공
- ✅ 로그에 발송 기록 남음

---

### 테스트 9: 발송 현황 조회

**목표:** 급여명세서 발송 현황을 정확히 표시하는지 확인

**절차:**
1. 메인 화면 하단 "발송 상태" 바 확인
2. 거래처 선택 후 연월 변경
3. 발송 상태 업데이트 확인

**예상 결과:**
- ✅ 발송 상태 표시: "5명 중 3명 발송 완료 (60%)"
- ✅ 연월 변경 시 즉시 업데이트
- ✅ 404 에러 없음

---

### 테스트 10: 로그 조회

**목표:** 메일 로그 및 급여 발송 로그가 정상 저장/조회되는지 확인

**절차:**
1. 이메일 발송 후 API 호출 확인
2. 서버에서 로그 조회:

```bash
# 메일 로그
curl "http://25.2.89.129:8000/logs/mail?clientId=1&ym=202501" -H "Content-Type: application/json"

# 급여 발송 로그
curl "http://25.2.89.129:8000/logs/payroll-send?clientId=1&ym=202501" -H "Content-Type: application/json"
```

**예상 결과:**
- ✅ 로그 데이터 반환됨
- ✅ 발송일시, 수신자, 결과 등 정보 포함

---

## 📊 테스트 결과 요약

| 테스트 항목 | 상태 | 비고 |
|------------|------|------|
| 1. 앱 시작 및 설정 로드 | ⬜ |  |
| 2. 거래처 선택 및 직원 목록 로드 | ⬜ |  |
| 3. 신규 직원 추가 (사번 자동 생성) | ⬜ |  |
| 4. 월별 근무 데이터 입력 (두루누리) | ⬜ |  |
| 5. 급여 계산 (두루누리 포함) | ⬜ |  |
| 6. 급여 확정 (마감) | ⬜ |  |
| 7. 급여명세서 생성 (파일명 사번 포함) | ⬜ |  |
| 8. SMTP 설정 및 이메일 발송 | ⬜ |  |
| 9. 발송 현황 조회 | ⬜ |  |
| 10. 로그 조회 | ⬜ |  |

**체크리스트:**
- ⬜ → ✅ (성공)
- ⬜ → ❌ (실패)

---

## 🐛 알려진 이슈 및 해결 방법

### 이슈 1: 500 에러 - AppSettings/SmtpConfig 조회 실패

**원인:** DB에 초기 데이터가 없음

**해결:**
```bash
python init_db.py
```

### 이슈 2: 404 에러 - 발송 상태 조회 실패

**원인:** 해당 거래처/연월에 발송 로그가 없음

**해결:** 정상 동작. 발송 이력이 없으면 404 반환

### 이슈 3: Null check 에러

**원인:** `provider.currentClient!` 사용 시 null 가능성

**해결:** Flutter 코드에서 null 체크 추가 (이미 수정됨)

### 이슈 4: 사번(EmpNo) 표시 안 됨

**원인:** DB 트리거 미생성 또는 기존 직원에 사번 미할당

**해결:**
1. DB 트리거 생성 확인
2. 기존 직원 수정 후 저장하여 사번 자동 할당

---

## 🎓 고급 테스트 (선택사항)

### A. 성능 테스트

**목표:** 대량 데이터 처리 성능 확인

**절차:**
1. 거래처에 직원 100명 추가
2. 모든 직원의 월별 근무 데이터 입력
3. 전체 급여 계산 실행
4. 소요 시간 측정

**예상 결과:**
- 100명 급여 계산: 3초 이내

### B. 동시성 테스트

**목표:** 여러 클라이언트에서 동시 접속 시 안정성 확인

**절차:**
1. 2개의 Windows PC에서 동시에 앱 실행
2. 동일한 거래처 선택
3. 동시에 직원 추가/수정

**예상 결과:**
- ✅ 데이터 충돌 없음
- ✅ 트랜잭션 무결성 유지

### C. 자동 발송 테스트

**목표:** 자동 발송 시스템 작동 확인

**절차:**
1. 거래처의 급여명세서발송일을 오늘로 설정
2. 앱 실행 유지
3. 자동 발송 타이머 대기 (5분 간격)

**예상 결과:**
- ✅ 자동 발송 실행됨
- ✅ 로그에 [AUTO] 표시
- ✅ 급여발송로그 테이블에 기록

---

## 📞 지원

문제 발생 시:
1. `python test_server.py` 실행하여 서버 상태 확인
2. `python init_db.py` 재실행
3. 서버 로그 확인: `server.py` 실행 중인 터미널
4. Flutter 로그 확인: Debug Console

**긴급 문제:**
- GitHub Issue: https://github.com/Durantax/payroll/issues
- PR 코멘트: https://github.com/Durantax/payroll/pull/1

---

## ✅ 최종 체크

모든 테스트 완료 후:

- [ ] 서버가 안정적으로 실행됨
- [ ] Flutter 앱이 에러 없이 작동함
- [ ] 사번(EmpNo) 시스템이 정상 작동함
- [ ] 두루누리 체크박스가 정상 작동함
- [ ] 급여명세서 파일명에 사번이 포함됨
- [ ] 이메일 발송이 정상 작동함
- [ ] 로그가 정확히 기록됨
- [ ] 마감(확정) 기능이 정상 작동함

**테스트 완료 날짜:** __________  
**테스트 수행자:** __________  
**전체 결과:** ✅ 성공 / ❌ 실패  
