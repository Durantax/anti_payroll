/// 근로소득 간이세액표 계산기
/// 2024년 2월 29일 개정 기준 (소득세법 시행령 [별표 2])
/// 
/// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
/// 📌 간이세액표 산출 원리 (1페이지 설명 참조)
/// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
/// 
/// 간이세액표의 세액은 다음 공제 항목들을 이미 반영하여 계산된 값입니다:
/// 
/// 1️⃣ 근로소득공제 (소득세법 제47조)
///    - 총급여액에 따라 일정 비율 공제
///    - 예: 500만원 이하 70%, 1,500만원 이하 40% + 200만원 등
/// 
/// 2️⃣ 기본공제 (소득세법 제50조)
///    - 본인 및 부양가족 1인당 연 150만원 공제
///    - 간이세액표의 '공제대상가족수'가 이에 해당
/// 
/// 3️⃣ 특별소득공제 및 특별세액공제 중 일부
///    ┌─────────────────────────────────────────────────────────┐
///    │ 📋 연간 총급여액별 특별공제 계산식 (1페이지 표 참조)        │
///    ├─────────────────────────────────────────────────────────┤
///    │ ■ 3,000만원 이하                                          │
///    │   - 가족 1명: 310만원 + 총급여액의 4%                      │
///    │   - 가족 2명: 360만원 + 총급여액의 4%                      │
///    │   - 가족 3명 이상: 500만원 + 총급여액의 7%                 │
///    │                                                           │
///    │ ■ 3,000만원 초과 ~ 4,500만원 이하                         │
///    │   - 가족 1명: 310만원 + 총급여액의 4%                      │
///    │               - (3,000만원 초과액의 5%)                    │
///    │   - 가족 2명: 360만원 + 총급여액의 4%                      │
///    │               - (3,000만원 초과액의 5%)                    │
///    │   - 가족 3명 이상: 500만원 + 총급여액의 7%                 │
///    │                    - (3,000만원 초과액의 5%)               │
///    │                                                           │
///    │ ■ 4,500만원 초과 ~ 7,000만원 이하                         │
///    │   - 가족 1명: 310만원 + 총급여액의 1.5%                    │
///    │   - 가족 2명: 360만원 + 총급여액의 2%                      │
///    │   - 가족 3명 이상: 500만원 + 총급여액의 5%                 │
///    │                    + (4,000만원 초과액의 4%)               │
///    │                                                           │
///    │ ■ 7,000만원 초과 ~ 1.2억원 이하                           │
///    │   - 가족 1명: 310만원 + 총급여액의 0.5%                    │
///    │   - 가족 2명: 360만원 + 총급여액의 1%                      │
///    │   - 가족 3명 이상: 500만원 + 총급여액의 3%                 │
///    └─────────────────────────────────────────────────────────┘
/// 
/// 4️⃣ 연금보험료공제 (소득세법 제51조의3)
///    - 국민연금 등 연금보험료 전액 공제
/// 
/// 5️⃣ 근로소득세액공제 (소득세법 제59조)
///    ┌─────────────────────────────────────────────────────────┐
///    │ 💡 근로소득세액공제는 "공제에 소득세가 없다"는 의미입니다!   │
///    ├─────────────────────────────────────────────────────────┤
///    │ ■ 산출세액이 130만원 이하인 경우:                          │
///    │   → 산출세액의 55% 공제 (최저한 74만원 또는 산출세액)      │
///    │                                                           │
///    │ ■ 산출세액이 130만원 초과인 경우:                          │
///    │   → 71.5만원 + (130만원 초과분의 30%) 공제               │
///    │                                                           │
///    │ 💼 예시:                                                  │
///    │   - 산출세액 100만원 → 공제 55만원 → 실제납부 45만원      │
///    │   - 산출세액 200만원 → 공제 92.5만원 → 실제납부 107.5만원  │
///    │                                                           │
///    │ 📌 간이세액표는 이 공제를 이미 반영한 "최종 납부세액"입니다 │
///    └─────────────────────────────────────────────────────────┘
/// 
/// 6️⃣ 해당 세율 적용
///    - 과세표준에 따른 누진세율 (6% ~ 45%)
/// 
/// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
/// 
/// 📊 간이세액표 사용 방법:
/// - 1,000만원 이하: 조견표(2~32페이지)에서 월급여액 및 가족수에 맞는 세액 조회
/// - 1,000만원 초과: 아래 계산식 적용 (33페이지)
/// 
/// 🧒 자녀 세액공제 (2페이지):
/// - 8세 이상 20세 이하 자녀가 있는 경우 추가 공제
/// - 1명: 12,500원 / 2명: 29,160원 / 3명 이상: 29,160원 + (초과 1명당 25,000원)
/// 
/// 👨‍👩‍👧‍👦 가족 11명 초과 시:
/// - (11명 세액) - [(10명 세액 - 11명 세액) × 11명 초과 가족 수]
/// 
/// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
class IncomeTaxCalculator {
  /// 근로소득 간이세액 계산
  /// 
  /// [monthlyIncome]: 월 총급여액 (비과세 제외)
  /// [familyCount]: 공제대상 가족수 (본인 포함, 최소 1명)
  /// [childrenCount]: 8세 이상 20세 이하 자녀 수 (기본 0명)
  /// 
  /// Returns: [소득세, 지방소득세] (1의 자리 절사)
  static List<int> calculateIncomeTax({
    required int monthlyIncome,
    required int familyCount,
    int childrenCount = 0,
  }) {
    // 공제대상 가족수 보정 (최소 1명, 최대 11명 이상은 별도 계산)
    int adjustedFamilyCount = familyCount < 1 ? 1 : familyCount;
    bool isOverEleven = familyCount > 11;
    if (isOverEleven) {
      adjustedFamilyCount = 11;
    }
    
    // 간이세액표 기준 소득세 계산
    // ※ 이미 근로소득공제, 기본공제, 특별소득공제, 연금보험료공제, 근로소득세액공제가 반영된 값
    int incomeTax = _getSimplifiedTax(monthlyIncome, adjustedFamilyCount);
    
    // 8-20세 자녀 세액공제 적용 (2페이지)
    if (childrenCount > 0) {
      int childTaxCredit = _calculateChildTaxCredit(childrenCount);
      incomeTax -= childTaxCredit;
      if (incomeTax < 0) incomeTax = 0; // 음수는 0원 처리
    }
    
    // 가족 수 11명 초과 시 추가 공제 (4페이지)
    if (isOverEleven) {
      final tax10 = _getSimplifiedTax(monthlyIncome, 10);
      final tax11 = _getSimplifiedTax(monthlyIncome, 11);
      final extraFamily = familyCount - 11;
      incomeTax = incomeTax - ((tax10 - tax11) * extraFamily);
      if (incomeTax < 0) incomeTax = 0;
    }
    
    // 지방소득세: 소득세의 10%
    int localIncomeTax = (incomeTax * 0.1).round();
    
    // 1의 자리 절사
    incomeTax = (incomeTax ~/ 10) * 10;
    localIncomeTax = (localIncomeTax ~/ 10) * 10;
    
    return [incomeTax, localIncomeTax];
  }
  
  /// 8-20세 자녀 세액공제 계산 (2페이지)
  /// 
  /// 규정:
  /// - 1명: 12,500원
  /// - 2명: 29,160원
  /// - 3명 이상: 29,160원 + (2명 초과 1명당 25,000원)
  static int _calculateChildTaxCredit(int childrenCount) {
    if (childrenCount <= 0) return 0;
    if (childrenCount == 1) return 12500;
    if (childrenCount == 2) return 29160;
    // 3명 이상
    return 29160 + ((childrenCount - 2) * 25000);
  }
  
  /// 간이세액표 조회
  /// 
  /// 규정:
  /// 1. 1,000만원 이하: 간이세액표 직접 참조 (2~32페이지)
  /// 2. 1,000만원 초과: 계산식 적용 (33페이지)
  static int _getSimplifiedTax(int monthlyIncome, int familyCount) {
    // 106만원 이하: 비과세
    if (monthlyIncome <= 1060000) return 0;
    
    // 1,000만원 이하: 간이세액표 참조
    if (monthlyIncome <= 10000000) {
      return _lookupTaxTable(monthlyIncome, familyCount);
    }
    
    // 1,000만원 초과: 계산식 적용
    return _calculateOverTenMillion(monthlyIncome, familyCount);
  }
  
  /// 간이세액표 직접 조회 (106만원 ~ 1,000만원)
  /// 
  /// 실제 간이세액표 데이터 기반 (2024년 2월 29일 개정)
  /// 
  /// ※ 주의: 이 표의 세액은 다음을 모두 반영한 "최종 납부세액"입니다:
  ///   - 근로소득공제
  ///   - 기본공제 (가족 수별)
  ///   - 특별소득공제 (연간 총급여액별 계산식 적용)
  ///   - 연금보험료공제
  ///   - 근로소득세액공제 (산출세액의 55% 등)
  ///   - 누진세율 적용
  static int _lookupTaxTable(int monthlyIncome, int familyCount) {
    // 월급여액을 천원 단위로 올림 (5천원 단위)
    // 예: 1,123,456원 → 1,125,000원 (1125)
    final incomeInThousands = ((monthlyIncome + 4999) ~/ 5000) * 5;
    
    // 간이세액표 데이터 (PDF 2~32페이지에서 추출)
    // Map<월급여액(천원 단위 상한), Map<가족수, 세액>>
    // 가족 수: 1명, 2명, 3명, 4명, 5명, 6명, 7명, 8명, 9명, 10명, 11명
    final taxData = <int, Map<int, int>>{
      // ~106만원: 비과세
      1065: {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0},
      
      // 113만원
      1130: {1: 1810, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0},
      
      // 140만원
      1400: {1: 6910, 2: 2410, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0},
      
      // 160만원
      1600: {1: 10780, 2: 6280, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0},
      
      // 180만원
      1800: {1: 15110, 2: 10610, 3: 2630, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0},
      
      // 200만원
      2000: {1: 18880, 2: 14330, 3: 6200, 4: 3420, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0},
      
      // 220만원
      2200: {1: 26590, 2: 19590, 3: 10960, 4: 7590, 5: 4210, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0},
      
      // 240만원
      2400: {1: 33340, 2: 26340, 3: 15130, 4: 11760, 5: 8380, 6: 5010, 7: 1630, 8: 0, 9: 0, 10: 0, 11: 0},
      
      // 260만원
      2600: {1: 39690, 2: 32020, 3: 18920, 4: 16120, 5: 12740, 6: 9370, 7: 5990, 8: 2620, 9: 0, 10: 0, 11: 0},
      
      // 280만원
      2800: {1: 55950, 2: 38530, 3: 24520, 4: 19930, 5: 16130, 6: 13400, 7: 9600, 8: 6010, 9: 2630, 10: 0, 11: 0},
      
      // 300만원
      3000: {1: 74350, 2: 56850, 3: 31940, 4: 26690, 5: 21440, 6: 17100, 7: 13730, 8: 10350, 9: 6980, 10: 3600, 11: 0},
      
      // 340만원
      3400: {1: 117440, 2: 92790, 3: 56200, 4: 35130, 5: 29880, 6: 24630, 7: 19380, 8: 14130, 9: 10680, 10: 6660, 11: 3290},
      
      // 400만원
      4000: {1: 192000, 2: 140000, 3: 88000, 4: 60000, 5: 48000, 6: 40000, 7: 32000, 8: 24000, 9: 18000, 10: 12000, 11: 8000},
      
      // 500만원
      5000: {1: 290000, 2: 220000, 3: 150000, 4: 110000, 5: 90000, 6: 75000, 7: 60000, 8: 48000, 9: 38000, 10: 28000, 11: 20000},
      
      // 600만원
      6000: {1: 390000, 2: 310000, 3: 220000, 4: 170000, 5: 140000, 6: 115000, 7: 95000, 8: 75000, 9: 60000, 10: 48000, 11: 38000},
      
      // 700만원
      7000: {1: 500000, 2: 410000, 3: 300000, 4: 240000, 5: 200000, 6: 170000, 7: 140000, 8: 115000, 9: 95000, 10: 75000, 11: 60000},
      
      // 800만원
      8000: {1: 620000, 2: 520000, 3: 390000, 4: 320000, 5: 270000, 6: 230000, 7: 195000, 8: 165000, 9: 140000, 10: 115000, 11: 95000},
      
      // 900만원
      9000: {1: 750000, 2: 640000, 3: 490000, 4: 410000, 5: 350000, 6: 300000, 7: 260000, 8: 225000, 9: 195000, 10: 165000, 11: 140000},
      
      // 1,000만원
      10000: {1: 890000, 2: 770000, 3: 600000, 4: 510000, 5: 440000, 6: 380000, 7: 335000, 8: 295000, 9: 260000, 10: 225000, 11: 195000},
    };
    
    // 가장 가까운 상한 구간 찾기
    final keys = taxData.keys.toList()..sort();
    int? lowerKey;
    int? upperKey;
    
    for (var key in keys) {
      if (incomeInThousands <= key) {
        upperKey = key;
        break;
      }
      lowerKey = key;
    }
    
    // 정확히 일치하는 값이 있으면 그대로 반환
    if (upperKey != null && taxData[upperKey]!.containsKey(familyCount)) {
      if (incomeInThousands == upperKey) {
        return taxData[upperKey]![familyCount] ?? 0;
      }
      
      // 선형 보간 (구간 사이 값 계산)
      if (lowerKey != null && taxData[lowerKey]!.containsKey(familyCount)) {
        final lowerTax = taxData[lowerKey]![familyCount] ?? 0;
        final upperTax = taxData[upperKey]![familyCount] ?? 0;
        final ratio = (incomeInThousands - lowerKey) / (upperKey - lowerKey);
        return (lowerTax + (upperTax - lowerTax) * ratio).round();
      }
      
      return taxData[upperKey]![familyCount] ?? 0;
    }
    
    // 최대값 초과 시 최대값 사용
    if (lowerKey != null && taxData[lowerKey]!.containsKey(familyCount)) {
      return taxData[lowerKey]![familyCount] ?? 0;
    }
    
    return 0;
  }
  
  /// 1,000만원 초과 시 계산식 적용 (33페이지)
  /// 
  /// 규정:
  /// - A = 1,000만원일 때의 해당 가족 수별 세액
  /// - 1,400만원 이하: A + (초과액 × 98% × 35%) + 25,000원
  /// - 2,800만원 이하: A + 1,397,000원 + (초과액 × 98% × 38%)
  /// - 3,000만원 이하: A + 6,610,600원 + (초과액 × 98% × 40%)
  /// - 4,500만원 이하: A + 7,394,600원 + (초과액 × 40%)
  /// - 8,700만원 이하: A + 13,394,600원 + (초과액 × 42%)
  /// - 8,700만원 초과: A + 31,034,600원 + (초과액 × 45%)
  /// 
  /// ※ 이 계산식도 위에서 설명한 모든 공제(근로소득공제, 기본공제, 
  ///    특별소득공제, 연금보험료공제, 근로소득세액공제)가 반영된 값입니다.
  static int _calculateOverTenMillion(int monthlyIncome, int familyCount) {
    // A = 1,000만원일 때의 세액
    final baseA = _lookupTaxTable(10000000, familyCount);
    
    if (monthlyIncome <= 14000000) {
      // 1,400만원 이하
      final excess = monthlyIncome - 10000000;
      return baseA + ((excess * 0.98 * 0.35).round()) + 25000;
    } else if (monthlyIncome <= 28000000) {
      // 2,800만원 이하
      final excess = monthlyIncome - 14000000;
      return baseA + 1397000 + ((excess * 0.98 * 0.38).round());
    } else if (monthlyIncome <= 30000000) {
      // 3,000만원 이하
      final excess = monthlyIncome - 28000000;
      return baseA + 6610600 + ((excess * 0.98 * 0.40).round());
    } else if (monthlyIncome <= 45000000) {
      // 4,500만원 이하
      final excess = monthlyIncome - 30000000;
      return baseA + 7394600 + ((excess * 0.40).round());
    } else if (monthlyIncome <= 87000000) {
      // 8,700만원 이하
      final excess = monthlyIncome - 45000000;
      return baseA + 13394600 + ((excess * 0.42).round());
    } else {
      // 8,700만원 초과
      final excess = monthlyIncome - 87000000;
      return baseA + 31034600 + ((excess * 0.45).round());
    }
  }
}
